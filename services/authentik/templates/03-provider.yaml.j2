version: 1
metadata:
  name: Passing Circle - OIDC Provider
  labels:
    blueprints.goauthentik.io/instantiate: "true"
entries:
  # Scope mapping for preferred_username (ensure it's included in tokens)
  - model: authentik_providers_oauth2.scopemapping
    id: scope-username
    identifiers:
      managed: goauthentik.io/providers/oauth2/scope-openid
    state: present
    attrs:
      name: "OpenID Connect scope (openid)"
      scope_name: openid
      expression: |
        return {
          "sub": request.user.uid,
          "preferred_username": request.user.username,
        }

  # OAuth2/OIDC provider
  - model: authentik_providers_oauth2.oauth2provider
    id: provider-matrix
    identifiers:
      name: passingcircle-matrix
    attrs:
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      client_type: confidential
      client_id: "{{ oidc_client_id }}"
      client_secret: "{{ oidc_client_secret }}"
      redirect_uris:
        - url: "https://{{ domain }}/_synapse/client/oidc/callback"
          matching_mode: strict
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]

  # Application
  - model: authentik_core.application
    id: app-matrix
    identifiers:
      slug: passingcircle-matrix
    attrs:
      name: "Passing Circle Chat"
      provider: !Find [authentik_providers_oauth2.oauth2provider, [name, passingcircle-matrix]]
      meta_launch_url: "https://{{ domain }}/element/"
      policy_engine_mode: any
