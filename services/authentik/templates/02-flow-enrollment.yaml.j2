version: 1
metadata:
  name: Passing Circle - Enrollment Flow
  labels:
    blueprints.goauthentik.io/instantiate: "true"
entries:
  # Enrollment flow
  - model: authentik_flows.flow
    id: flow-enrollment
    identifiers:
      slug: passingcircle-enrollment
    attrs:
      name: "Passkey Registration"
      title: "Register"
      designation: enrollment
      authentication: none

  # Prompt fields for Stage 1
  # Field 1: Username (visible, editable, expression-generated)
  - model: authentik_stages_prompt.prompt
    id: prompt-username
    identifiers:
      field_key: username
      name: passingcircle-prompt-username
    attrs:
      label: "Your Username (you can edit this if you want)"
      type: text
      required: true
      placeholder: "Generating your username..."
      order: 0
      initial_value: |
        import random
        adjectives = ["swift", "bright", "calm", "bold", "keen", "warm", "cool", "fair", "glad", "wise"]
        animals = ["fox", "owl", "bear", "deer", "hawk", "wolf", "lynx", "hare", "wren", "dove"]
        adj = random.choice(adjectives)
        animal = random.choice(animals)
        num = random.randint(1000, 9999)
        return f"{adj}-{animal}-{num}"
      initial_value_expression: true

  # Prompt stage 1 - collects username only
  - model: authentik_stages_prompt.promptstage
    id: stage-prompt
    identifiers:
      name: passingcircle-prompt
    attrs:
      fields:
        - !KeyOf prompt-username
      validation_policies: []

  # Expression policy to derive email and name from submitted username
  - model: authentik_policies_expression.expressionpolicy
    id: policy-derive-attributes
    identifiers:
      name: passingcircle-derive-user-attributes
    attrs:
      execution_logging: false
      expression: |
        # Read username from Stage 1 submission
        username = request.context.get('prompt_data', {}).get('username', 'user')

        # Derive email and name
        email = f"{username}@{{ domain }}"
        name = username

        # Inject into prompt_data for User Write stage
        if 'prompt_data' not in request.context:
            request.context['prompt_data'] = {}
        request.context['prompt_data']['email'] = email
        request.context['prompt_data']['name'] = name

        return True

  # User write stage - creates the account from prompt_data
  - model: authentik_stages_user_write.userwritestage
    id: stage-user-write
    identifiers:
      name: passingcircle-user-write
    attrs:
      create_users_as_inactive: false
      user_creation_mode: always_create
      user_type: internal

  # WebAuthn setup stage - register passkey
  - model: authentik_stages_authenticator_webauthn.authenticatorwebauthnstage
    id: stage-webauthn-setup
    identifiers:
      name: passingcircle-webauthn-setup
    attrs:
      friendly_name: "Register Passkey"
      resident_key_requirement: required
      user_verification: preferred
      authenticator_attachment: null

  # User login stage
  - model: authentik_stages_user_login.userloginstage
    id: stage-enrollment-login
    identifiers:
      name: passingcircle-enrollment-login
    attrs:
      session_duration: "seconds=0"
      remember_me_offset: "seconds=0"

  # Bind stages to flow (in correct order)
  # Order 10: Prompt stage - username input
  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, passingcircle-enrollment]]
      stage: !Find [authentik_stages_prompt.promptstage, [name, passingcircle-prompt]]
      order: 10
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false

  # Order 20: User Write stage - creates user from prompt_data
  # re_evaluate_policies: true ensures the derivation policy runs at execution time
  # (after username is submitted), not just during planning
  - model: authentik_flows.flowstagebinding
    id: binding-user-write
    identifiers:
      target: !Find [authentik_flows.flow, [slug, passingcircle-enrollment]]
      stage: !Find [authentik_stages_user_write.userwritestage, [name, passingcircle-user-write]]
      order: 20
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: true

  # Bind derivation policy to User Write - injects email/name into prompt_data
  # before User Write executes
  - model: authentik_policies.policybinding
    identifiers:
      target: !KeyOf binding-user-write
      policy: !KeyOf policy-derive-attributes
      order: 0

  # Order 30: WebAuthn setup - register passkey
  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, passingcircle-enrollment]]
      stage: !Find [authentik_stages_authenticator_webauthn.authenticatorwebauthnstage, [name, passingcircle-webauthn-setup]]
      order: 30
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false

  # Order 40: Login - automatically log in the new user
  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, passingcircle-enrollment]]
      stage: !Find [authentik_stages_user_login.userloginstage, [name, passingcircle-enrollment-login]]
      order: 40
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false
