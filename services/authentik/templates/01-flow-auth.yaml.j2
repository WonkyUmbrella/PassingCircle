version: 1
metadata:
  name: Passing Circle - Authentication Flow
  labels:
    blueprints.goauthentik.io/instantiate: "true"
entries:
  # Authentication flow
  - model: authentik_flows.flow
    id: flow-auth
    identifiers:
      slug: passingcircle-auth
    attrs:
      name: "Passkey Authentication"
      title: "Sign In"
      designation: authentication
      authentication: none

  # Identification stage - username required for passkey lookup
  - model: authentik_stages_identification.identificationstage
    id: stage-identification
    identifiers:
      name: passingcircle-identification
    attrs:
      user_fields:
        - username
      enrollment_flow: !Find [authentik_flows.flow, [slug, passingcircle-enrollment]]
      sources: []

  # WebAuthn validation stage (passwordless mode)
  - model: authentik_stages_authenticator_validate.authenticatorvalidatestage
    id: stage-webauthn-validate
    identifiers:
      name: passingcircle-webauthn-validate
    attrs:
      device_classes:
        - webauthn
      not_configured_action: deny
      webauthn_user_verification: preferred

  # User login stage
  - model: authentik_stages_user_login.userloginstage
    id: stage-login
    identifiers:
      name: passingcircle-login
    attrs:
      session_duration: "seconds=0"
      remember_me_offset: "seconds=0"

  # Bind stages to flow
  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, passingcircle-auth]]
      stage: !Find [authentik_stages_identification.identificationstage, [name, passingcircle-identification]]
      order: 10
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, passingcircle-auth]]
      stage: !Find [authentik_stages_authenticator_validate.authenticatorvalidatestage, [name, passingcircle-webauthn-validate]]
      order: 20
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false

  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, passingcircle-auth]]
      stage: !Find [authentik_stages_user_login.userloginstage, [name, passingcircle-login]]
      order: 30
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false
